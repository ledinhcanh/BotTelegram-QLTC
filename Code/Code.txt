const TOKEN = "8521826994:AAEtF7qf2tn5lUMsfgDLi3iI1Qh5qOrUThX8k"; // Thay TOKEN cá»§a báº¡n
const API_URL = `https://api.telegram.org/bot${TOKEN}`;
const SHEET_ID = "15jZjGuSDXaOgl1OIhC-dE0zLs2_8zRty2AezyJMOvnQ"; // Thay ID Sheet cá»§a báº¡n
const ADMIN_IDS = ["924080826"]; // Thay ID Telegram cá»§a báº¡n

// --- Cáº¤U HÃŒNH Vá»Š TRÃ (Layout Má»šI) ---
// TiÃªu Ä‘á» sáº½ á»Ÿ dÃ²ng START_ROW - 1 (tá»©c lÃ  dÃ²ng 15)
// Dá»¯ liá»‡u báº¯t Ä‘áº§u ghi tá»« dÃ²ng 16
const START_ROW = 16; 
const START_COL = 2; 

// --- Cáº¤U HÃŒNH NHÃ“M ---
const CATEGORIES = [
  "ğŸœ Ä‚n uá»‘ng", "ğŸ›ï¸ Mua sáº¯m", "ğŸ‰ ÄÃ¡m xÃ¡", "â›½ Äá»• xÄƒng", "ğŸ›µ Xe cá»™", 
  "ğŸ‘ª Bá»‘ máº¹", "ğŸ’• Vá»£ chá»“ng", "ğŸ‘¶ Con cÃ¡i", "ğŸ’¸ Chuyá»ƒn khoáº£n", 
  "ğŸ  Äiá»‡n nÆ°á»›c", "ğŸ¥ Thuá»‘c men", "ğŸ“¦ KhÃ¡c"
];

const SHORTCUTS = {
  "an": "ğŸœ Ä‚n uá»‘ng", "uong": "ğŸœ Ä‚n uá»‘ng", "mua": "ğŸ›ï¸ Mua sáº¯m", "sam": "ğŸ›ï¸ Mua sáº¯m",
  "dam": "ğŸ‰ ÄÃ¡m xÃ¡", "tham": "ğŸ‰ ÄÃ¡m xÃ¡", "xang": "â›½ Äá»• xÄƒng", "dau": "â›½ Äá»• xÄƒng",
  "xe": "ğŸ›µ Xe cá»™", "sua": "ğŸ›µ Xe cá»™", "bm": "ğŸ‘ª Bá»‘ máº¹", "ob": "ğŸ‘ª Bá»‘ máº¹",
  "vk": "ğŸ’• Vá»£ chá»“ng", "ck": "ğŸ’• Vá»£ chá»“ng", "con": "ğŸ‘¶ Con cÃ¡i", "hoc": "ğŸ‘¶ Con cÃ¡i",
  "ck": "ğŸ’¸ Chuyá»ƒn khoáº£n", "bank": "ğŸ’¸ Chuyá»ƒn khoáº£n", "gui": "ğŸ’¸ Chuyá»ƒn khoáº£n",
  "dien": "ğŸ  Äiá»‡n nÆ°á»›c", "nuoc": "ğŸ  Äiá»‡n nÆ°á»›c", "nha": "ğŸ  Äiá»‡n nÆ°á»›c",
  "thuoc": "ğŸ¥ Thuá»‘c men", "kham": "ğŸ¥ Thuá»‘c men"
};

// --- 1. SETUP ---
function setWebhook() {
  // ğŸ‘‡ THAY URL WEB APP Cá»¦A Báº N VÃ€O DÆ¯á»šI ğŸ‘‡
  var webAppUrl = 'https://script.google.com/macros/s/AKfycby6saFceJQ0NKHMFKE7U26qo9-BrCV_nIgEp94EmQj24jMHcTeq9Pckmd28PNWRaqc0/exec'; 
  var payload = { method: 'setWebhook', url: webAppUrl };
  UrlFetchApp.fetch(API_URL + '/', { method: 'post', payload: JSON.stringify(payload), contentType: 'application/json' });
}

function setupBotMenu() {
  const commands = [
    { command: "thu", description: "Ghi thu nháº­p" },
    { command: "chi", description: "Ghi chi tiÃªu" },
    { command: "report", description: "BÃ¡o cÃ¡o chi tiáº¿t" },
    { command: "undo", description: "XÃ³a dÃ²ng cuá»‘i" },
    { command: "giavang", description: "Xem giÃ¡ vÃ ng SJC" },
    { command: "thoitiet", description: "Xem thá»i tiáº¿t Háº£i PhÃ²ng" },
    { command: "help", description: "HÆ°á»›ng dáº«n sá»­ dá»¥ng" }
  ];
  UrlFetchApp.fetch(API_URL + "/setMyCommands", { method: "post", payload: { commands: JSON.stringify(commands) } });
}

function getWeather() {
  try {
    // 1. Cáº¤U HÃŒNH
    const apiKey = "79fa4d8ec6844a4d90c82408252611";
    const city = "HaiPhong";
    // Quan trá»ng: ÄÃ£ Ä‘á»•i aqi=yes Ä‘á»ƒ láº¥y dá»¯ liá»‡u cháº¥t lÆ°á»£ng khÃ´ng khÃ­
    const url = `https://api.weatherapi.com/v1/current.json?key=${apiKey}&q=${city}&aqi=yes&lang=vi`; 

    const response = UrlFetchApp.fetch(url);
    const data = JSON.parse(response.getContentText());

    // 2. Láº¤Y Dá»® LIá»†U CÆ  Báº¢N
    const current = data.current;
    const location = data.location;
    const conditionText = current.condition.text;
    const isDay = current.is_day === 1 ? "â˜€ï¸" : "ğŸŒ™";

    // 3. Xá»¬ LÃ CHáº¤T LÆ¯á»¢NG KHÃ”NG KHÃ (AQI)
    let aqiMsg = "";
    if (current.air_quality) {
      const aq = current.air_quality;
      const pm25 = aq.pm2_5.toFixed(1); // LÃ m trÃ²n 1 sá»‘ tháº­p phÃ¢n
      const epaIndex = aq["us-epa-index"]; // Láº¥y chá»‰ sá»‘ EPA (1-6)

      let aqiStatus = "KhÃ´ng xÃ¡c Ä‘á»‹nh";
      let aqiIcon = "â“";

      // ÄÃ¡nh giÃ¡ dá»±a trÃªn US-EPA Index
      switch (epaIndex) {
        case 1: aqiStatus = "Tá»‘t"; aqiIcon = "ğŸŸ¢"; break;
        case 2: aqiStatus = "Trung bÃ¬nh"; aqiIcon = "ğŸŸ¡"; break;
        case 3: aqiStatus = "KÃ©m (Nháº¡y cáº£m)"; aqiIcon = "ğŸŸ "; break;
        case 4: aqiStatus = "Xáº¥u"; aqiIcon = "ğŸ”´"; break;
        case 5: aqiStatus = "Ráº¥t xáº¥u"; aqiIcon = "ğŸŸ£"; break;
        case 6: aqiStatus = "Nguy háº¡i"; aqiIcon = "â˜ ï¸"; break;
      }
      
      aqiMsg = `ğŸ˜· Cháº¥t lÆ°á»£ng KK: ${aqiIcon} *${aqiStatus}*\n` + 
               `   (PM2.5: ${pm25} Âµg/mÂ³)\n`;
    }

    // 4. Cáº¢NH BÃO THÃŠM (Äá»™ áº©m, Nhiá»‡t Ä‘á»™, UV)
    let advice = [];
    if (current.humidity < 40) advice.push("âš ï¸ Trá»i hanh khÃ´, nhá»› uá»‘ng Ä‘á»§ nÆ°á»›c!");
    if (current.uv > 7) advice.push("âš ï¸ UV cao, háº¡n cháº¿ ra náº¯ng trá»±c tiáº¿p.");
    if (current.temp_c < 16) advice.push("ğŸ§£ Trá»i láº¡nh, nhá»› máº·c áº¥m.");
    if (current.air_quality && current.air_quality["us-epa-index"] >= 4) advice.push("ğŸ˜· KhÃ´ng khÃ­ Ã´ nhiá»…m, nÃªn Ä‘eo kháº©u trang.");

    const adviceMsg = advice.length > 0 ? `\n${advice.join("\n")}` : "";

    // 5. TRáº¢ Vá»€ Káº¾T QUáº¢
    return `ğŸŒ¤ *THá»œI TIáº¾T ${location.name.toUpperCase()}*\n\n` +
           `ğŸ•’ Cáº­p nháº­t: ${location.localtime.split(" ")[1]}\n\n` +
           `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
           `ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™: *${current.temp_c}Â°C* (Cáº£m giÃ¡c: ${current.feelslike_c}Â°C)\n\n` +
           `${isDay} Tráº¡ng thÃ¡i: ${conditionText}\n\n` +
           `ğŸ’§ Äá»™ áº©m: *${current.humidity}%*\n\n` +
           `ğŸ’¨ GiÃ³: ${current.wind_kph} km/h (HÆ°á»›ng ${current.wind_dir})\n\n` +
           aqiMsg + // ChÃ¨n thÃ´ng tin AQI vÃ o Ä‘Ã¢y
           adviceMsg;

  } catch (e) {
    return "âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u thá»i tiáº¿t lÃºc nÃ y: " + e.message;
  }
}

// --- 2. Xá»¬ LÃ CHÃNH ---
function doPost(e) {
  const content = JSON.parse(e.postData.contents);
  if (content.callback_query) { handleCallback(content.callback_query); return; }
  if (!content.message || !content.message.text) return;
  
  const chatId = content.message.chat.id;
  const text = content.message.text;
  const userId = String(content.message.from.id);

  if (!isAuthorizedUser(userId)) return sendMessage(chatId, "ğŸš« Báº¡n khÃ´ng cÃ³ quyá»n.");

  const state = getUserState(userId);
  
  // 1. Xá»­ lÃ½ há»™i thoáº¡i (náº¿u Ä‘ang dá»Ÿ)
  if (state && text !== "/cancel" && text !== "/start") {
    handleConversation(chatId, userId, text, state);
    return;
  }

  // 2. Xá»­ lÃ½ lá»‡nh báº¯t Ä‘áº§u báº±ng "/"
  if (text.startsWith("/")) {
    if (text === "/cancel") clearUserState(userId, chatId);
    else if (text === "/start" || text === "/help") sendHelpMessage(chatId);
    else if (text.startsWith("/thu") || text.startsWith("/chi")) handleCommandStart(chatId, userId, text);
    else if (text.startsWith("/report")) handleReport(chatId, text);
    else if (text.startsWith("/undo")) undoLast(chatId);
    else if (text.startsWith("/giavang")) sendMessage(chatId, getGoldPrices());
    else if (text.startsWith("/thoitiet")) sendMessage(chatId, getWeather());
  } else {
    // 3. Xá»­ lÃ½ nháº­p liá»‡u tá»± do (ThÃ´ng minh hÆ¡n)
    // Cho phÃ©p nháº­p: "50k an", "an 50k", "chi 50k", "50k chi"...
    handleTextTransaction(chatId, text);
  }
}

function sendHelpMessage(chatId) {
  const helpText = 
    `ğŸ¤– *HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG BOT TÃ€I CHÃNH*\n` +
    `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n` +
    `1ï¸âƒ£ *GHI THU / CHI*\n` +
    `â€¢ CÃ¡ch 1 (Nhanh): GÃµ lá»‡nh trá»±c tiáº¿p\n` +
    `  \`/chi 50k an Äƒn sÃ¡ng\` (Chi 50k Äƒn sÃ¡ng)\n` +
    `  \`chi 1tr600 dien tiá»n Ä‘iá»‡n\` (Chi 1tr600)\n` +
    `  \`chi 1tr23k mua\` (Chi 1tr023k)\n` +
    `  \`/thu 10tr lÆ°Æ¡ng\` (Thu 10tr lÆ°Æ¡ng)\n` +
    `â€¢ CÃ¡ch 2 (Há»™i thoáº¡i): Báº¥m menu \`/thu\` hoáº·c \`/chi\` rá»“i lÃ m theo hÆ°á»›ng dáº«n cá»§a Bot.\n\n` +
    `2ï¸âƒ£ *XEM BÃO CÃO (/report)*\n` +
    `â€¢ \`/report\`: Xem tá»•ng há»£p thÃ¡ng nÃ y.\n` +
    `â€¢ \`/report 10/2025\`: Xem bÃ¡o cÃ¡o thÃ¡ng 10/2025.\n` +
    `â€¢ \`/report an\`: Xem chi tiáº¿t nhÃ³m "Ä‚n uá»‘ng" thÃ¡ng nÃ y.\n` +
    `â€¢ \`/report xang 10/2025\`: Xem tiá»n xÄƒng thÃ¡ng 10.\n\n` +
    `3ï¸âƒ£ *CÃC Lá»†NH KHÃC*\n` +
    `â€¢ \`/undo\`: XÃ³a giao dá»‹ch vá»«a nháº­p sai gáº§n nháº¥t.\n` +
    `â€¢ \`/giavang\`: Xem giÃ¡ vÃ ng SJC má»›i nháº¥t.\n` +
    `â€¢ \`/cancel\`: Há»§y lá»‡nh Ä‘ang nháº­p dá»Ÿ.\n\n` +
    `ğŸ’¡ *Máº¹o viáº¿t táº¯t nhÃ³m chi tiÃªu:*\n` +
    `an (Ä‚n uá»‘ng), xe (Xe cá»™), xang (XÄƒng), mua (Mua sáº¯m), ck (Chuyá»ƒn khoáº£n), con (Con cÃ¡i), dien/nuoc (Äiá»‡n nÆ°á»›c), thuoc (Thuá»‘c men)`;

  sendMessage(chatId, helpText);
}

// --- 3. PARSE Lá»†NH ---
function handleCommandStart(chatId, userId, text) {
  let args = text.split(" ");
  args[0] = args[0].replace("/", ""); 
  const type = args[0].toLowerCase(); 
  
  if (args.length === 1) {
    setUserState(userId, "WAITING_AMOUNT", { type: type });
    sendMessage(chatId, `ğŸ“ *GHI ${type.toUpperCase()}* (Cháº¿ Ä‘á»™ há»™i thoáº¡i)\n\nğŸ’° Nháº­p sá»‘ tiá»n:`);
    return;
  }
  processTransaction(chatId, args, type);
}

function handleTextTransaction(chatId, text) {
  const args = text.trim().split(/\s+/); // TÃ¡ch chuá»—i báº±ng khoáº£ng tráº¯ng
  if (args.length < 2) return; // Bá» qua náº¿u chá»‰ gÃµ 1 tá»« (vÃ­ dá»¥ "hello")

  const first = args[0].toLowerCase();
  const second = args[1].toLowerCase();

  // --- TRÆ¯á»œNG Há»¢P 1: CÃ³ chá»¯ "thu" hoáº·c "chi" rÃµ rÃ ng (Logic cÅ©) ---
  if (['thu', 'chi'].includes(first) || ['thu', 'chi'].includes(second)) {
    let type = ['thu', 'chi'].includes(first) ? first : second;
    processTransaction(chatId, args, type);
    return;
  }

  // --- TRÆ¯á»œNG Há»¢P 2 (Má»šI): Shortcut Ä‘á»©ng Ä‘áº§u + Tiá»n Ä‘á»©ng sau ---
  // VÃ­ dá»¥: "an 30k phá»Ÿ bÃ²" -> Tá»± Ä‘á»™ng lÃ  CHI
  if (SHORTCUTS[first] && isValidAmount(second)) {
    const category = SHORTCUTS[first];
    const amountStr = second;
    const desc = args.slice(2).join(" ");
    saveTransaction(chatId, amountStr, 'chi', category, desc);
    return;
  }

  // --- TRÆ¯á»œNG Há»¢P 3 (Má»šI): Tiá»n Ä‘á»©ng Ä‘áº§u + Shortcut Ä‘á»©ng sau ---
  // VÃ­ dá»¥: "30k an phá»Ÿ bÃ²" -> Tá»± Ä‘á»™ng lÃ  CHI
  if (isValidAmount(first) && SHORTCUTS[second]) {
    const amountStr = first;
    const category = SHORTCUTS[second];
    const desc = args.slice(2).join(" ");
    saveTransaction(chatId, amountStr, 'chi', category, desc);
    return;
  }

  // Náº¿u khÃ´ng khá»›p cÃ¡i nÃ o thÃ¬ bot im láº·ng (Ä‘á»ƒ trÃ¡nh spam khi chat bÃ¬nh thÆ°á»ng)
}

function processTransaction(chatId, args, type) {
  let amountStr, descStartIndex;
  if (["thu", "chi"].includes(args[0].toLowerCase())) {
    amountStr = args[1]; descStartIndex = 2;
  } else {
    amountStr = args[0]; descStartIndex = 2;
  }

  if (!isValidAmount(amountStr)) return sendMessage(chatId, `âš ï¸ Tiá»n khÃ´ng Ä‘Ãºng (${amountStr}).`);

  let category = "ğŸ“¦ KhÃ¡c";
  if (type === 'thu') {
    category = "Thu nháº­p";
  } else {
    if (args[descStartIndex] && SHORTCUTS[args[descStartIndex].toLowerCase()]) {
      category = SHORTCUTS[args[descStartIndex].toLowerCase()];
      descStartIndex++; 
    }
  }
  saveTransaction(chatId, amountStr, type, category, args.slice(descStartIndex).join(" "));
}

// --- 4. Há»˜I THOáº I ---
function handleConversation(chatId, userId, text, state) {
  const data = getUserData(userId);
  if (state === "WAITING_AMOUNT") {
    if (!isValidAmount(text)) return sendMessage(chatId, "âš ï¸ Tiá»n sai.");
    data.amount = text;
    if (data.type === 'thu') {
      data.category = "Thu nháº­p";
      setUserState(userId, "WAITING_DESC", data);
      sendMessage(chatId, "âœ… ÄÃ£ nháº­n tiá»n. Nháº­p nguá»“n thu:");
    } else {
      setUserState(userId, "WAITING_CATEGORY", data); 
      sendCategoryKeyboard(chatId, "ğŸ“‚ Chá»n nhÃ³m:");
    }
  } else if (state === "WAITING_DESC") {
    saveTransaction(chatId, data.amount, data.type, data.category, text);
    clearUserState(userId);
  }
}

function handleCallback(callback) {
  const userId = String(callback.from.id);
  const data = getUserData(userId);
  if (getUserState(userId) === "WAITING_CATEGORY") {
    data.category = callback.data;
    setUserState(userId, "WAITING_DESC", data);
    editMessage(callback.message.chat.id, callback.message.message_id, `âœ… ÄÃ£ chá»n: ${callback.data}`);
    sendMessage(callback.message.chat.id, `ğŸ“ Nháº­p mÃ´ táº£:`);
  }
  UrlFetchApp.fetch(`${API_URL}/answerCallbackQuery`, { method: "post", payload: JSON.stringify({ callback_query_id: callback.id }), contentType: 'application/json' });
}

// --- 5. LÆ¯U Dá»® LIá»†U & Táº O GIAO DIá»†N ---

function saveTransaction(chatId, rawAmount, type, category, description) {
  const parsedAmount = parseAmount(rawAmount);
  const formattedDesc = description ? (description.charAt(0).toUpperCase() + description.slice(1)) : "KhÃ´ng mÃ´ táº£";
  const now = new Date();
  const sheetName = getSheetNameByDate(now); 
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName(sheetName);

  // --- Táº O SHEET & DASHBOARD Náº¾U CHÆ¯A CÃ“ ---
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    
    // --- KHU Vá»°C Tá»”NG QUAN (ÄÃ£ Ä‘áº©y lÃªn Row 1) ---
    sheet.getRange("B1:C1").merge().setValue("ğŸ’° Tá»”NG QUAN").setFontWeight("bold").setHorizontalAlignment("center").setBackground("#cfe2f3");
    sheet.getRange("B2").setValue("ğŸ“¥ Thu:");
    sheet.getRange("B3").setValue("ğŸ“¤ Chi:");
    sheet.getRange("B4").setValue("ğŸ’µ DÆ°:");
    
    // --- KHU Vá»°C CHI TIáº¾T (ÄÃ£ Ä‘áº©y lÃªn Row 1) ---
    sheet.getRange("E1:F1").merge().setValue("ğŸ“‚ CHI TIáº¾T CHI TIÃŠU").setFontWeight("bold").setHorizontalAlignment("center").setBackground("#fff2cc");
    
    // --- CÃ”NG THá»¨C (Cáº­p nháº­t theo START_ROW má»›i) ---
    sheet.getRange("C2").setFormula(`=SUMIF(C${START_ROW}:C; "thu"; E${START_ROW}:E)`);
    sheet.getRange("C3").setFormula(`=SUMIF(C${START_ROW}:C; "chi"; E${START_ROW}:E)`);
    sheet.getRange("C4").setFormula('=C2-C3').setFontWeight("bold");
    
    // Query chi tiáº¿t
    const queryFormula = `=IFERROR(QUERY(B${START_ROW}:F; "SELECT D, SUM(E) WHERE C = 'chi' GROUP BY D ORDER BY SUM(E) DESC LABEL D '', SUM(E) ''"); "ChÆ°a cÃ³ dá»¯ liá»‡u")`;
    sheet.getRange("E2").setFormula(queryFormula);
    
    // Äá»‹nh dáº¡ng sá»‘
    sheet.getRange("C2:C4").setNumberFormat("#,##0");
    sheet.getRange("F2:F20").setNumberFormat("#,##0");
    
    // --- TIÃŠU Äá»€ Báº¢NG Dá»® LIá»†U ---
    const headerRow = START_ROW - 1; // DÃ²ng 15
    sheet.getRange(headerRow, START_COL, 1, 5).setValues([["Thá»i gian", "Loáº¡i", "NhÃ³m", "Sá»‘ tiá»n", "MÃ´ táº£"]]);
    sheet.getRange(headerRow, START_COL, 1, 5).setFontWeight("bold").setBackground("#4c4c4c").setFontColor("white");
    
    // KÃ­ch thÆ°á»›c cá»™t
    sheet.setColumnWidth(1, 20); sheet.setColumnWidth(2, 140); sheet.setColumnWidth(4, 130); sheet.setColumnWidth(6, 200); 
    sheet.getRange("E:E").setNumberFormat("#,##0"); 
  }

  // --- GHI Dá»® LIá»†U ---
  const dataRange = sheet.getRange(`B${START_ROW}:B`); 
  const lastRowIndex = dataRange.getValues().filter(String).length; 
  const writeRow = START_ROW + lastRowIndex;

  sheet.getRange(writeRow, START_COL, 1, 5).setValues([[now, type, category, parsedAmount, formattedDesc]]);
  sheet.getRange(writeRow, START_COL, 1, 5).setBorder(true, true, true, true, true, true, "#d9d9d9", SpreadsheetApp.BorderStyle.SOLID);
  
  // Xá»­ lÃ½ Dropdown
  const categoryCell = sheet.getRange(writeRow, 4);
  const rule = SpreadsheetApp.newDataValidation().requireValueInList(CATEGORIES).setAllowInvalid(true).build();
  if (category === "Thu nháº­p") categoryCell.clearDataValidations(); 
  else categoryCell.setDataValidation(rule);

  // LÆ°u tráº¡ng thÃ¡i Undo
  PropertiesService.getScriptProperties().setProperty(`CAN_UNDO_${chatId}`, writeRow);

  // --- Gá»¬I TIN NHáº®N ---
  const icon = type === 'thu' ? "ğŸŸ¢" : "ğŸ”´";
  const title = type === 'thu' ? "GHI NHáº¬N THU NHáº¬P" : "GHI NHáº¬N CHI TIÃŠU";
  
  const message = 
    `${icon} *${title}*\n` +
    `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n` + 
    `ğŸ’° *${formatCurrency(parsedAmount)}*\n\n` + 
    `ğŸ“‚ *NhÃ³m:* ${category}\n\n` + 
    `ğŸ“ *Ná»™i dung:* ${formattedDesc}\n\n` + 
    `ğŸ•’ ${now.toLocaleTimeString("vi-VN", {hour: '2-digit', minute:'2-digit'})} - ${sheetName}`;

  sendMessage(chatId, message);
}

// --- 6. REPORT & UTILS (UPDATED) ---

function handleReport(chatId, text) {
  let sheetName;
  let displayTime;
  let targetCategory = null;

  const argsStr = text.replace("/report", "").trim().toLowerCase();
  const dateMatch = argsStr.match(/(\d{1,2})\/(\d{4})/);
  
  if (dateMatch) {
    const month = parseInt(dateMatch[1]);
    const year = dateMatch[2];
    sheetName = `T${month}-${year}`;
    displayTime = `${month}/${year}`;
  } else {
    const now = new Date();
    sheetName = getSheetNameByDate(now);
    displayTime = `${now.getMonth() + 1}/${now.getFullYear()}`;
  }

  let keyword = argsStr.replace(/(\d{1,2})\/(\d{4})/, "").trim();
  if (keyword) {
    if (SHORTCUTS[keyword]) {
      targetCategory = SHORTCUTS[keyword];
    } else {
      const found = CATEGORIES.find(cat => cat.toLowerCase().includes(keyword));
      if (found) targetCategory = found;
    }
  }

  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(sheetName);
  
  if (!sheet) {
    return sendMessage(chatId, `âš ï¸ KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u thÃ¡ng *${displayTime}*.`);
  }
  
  const lastRow = sheet.getLastRow();
  if (lastRow < START_ROW) {
    return sendMessage(chatId, `ğŸ“Š ThÃ¡ng *${displayTime}* chÆ°a cÃ³ giao dá»‹ch nÃ o.`);
  }

  // Láº¥y dá»¯ liá»‡u tá»« START_ROW
  const data = sheet.getRange(`B${START_ROW}:F${lastRow}`).getValues();
  let resultText = "";
  let totalAmount = 0;
  let count = 0;

  if (targetCategory) {
    const details = [];
    data.forEach(row => {
      if (row[0] && row[2] === targetCategory) {
        const date = new Date(row[0]).toLocaleDateString("vi-VN", {day:'2-digit', month:'2-digit'});
        const money = parseFloat(row[3]);
        const desc = row[4];
        
        details.push(`- ${date}: *${formatCurrency(money)}* (${desc})`);
        totalAmount += money;
        count++;
      }
    });

    if (count === 0) return sendMessage(chatId, `â„¹ï¸ KhÃ´ng cÃ³ giao dá»‹ch nÃ o thuá»™c nhÃ³m *${targetCategory}* trong thÃ¡ng ${displayTime}.`);

    resultText = 
      `ğŸ“‚ *BÃO CÃO: ${targetCategory.toUpperCase()}*\n` +
      `ğŸ—“ï¸ ThÃ¡ng: ${displayTime}\n` +
      `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
      `ğŸ’° Tá»•ng cá»™ng: *${formatCurrency(totalAmount)}*\n` +
      `ğŸ”¢ Sá»‘ giao dá»‹ch: ${count}\n\n` +
      `ğŸ“ *Chi tiáº¿t:*\n` +
      details.join("\n");

  } else {
    let totalInc = 0, totalExp = 0;
    let catReport = {};

    data.forEach(row => {
      if(row[0]) {
        const type = row[1]; const cat = row[2] || "ğŸ“¦ KhÃ¡c"; const amt = parseFloat(row[3]) || 0;
        if (type === 'thu') totalInc += amt;
        else {
          totalExp += amt;
          catReport[cat] = (catReport[cat] || 0) + amt;
        }
      }
    });

    let catText = "";
    Object.entries(catReport).sort((a, b) => b[1] - a[1]).forEach(([k, v]) => catText += `- ${k}: *${formatCurrency(v)}*\n\n`);
    
    const balance = totalInc - totalExp;
    const emoji = balance >= 0 ? "ğŸ“ˆ" : "ğŸ“‰";

    resultText = 
      `ğŸ“Š *BÃO CÃO Tá»”NG Há»¢P THÃNG ${displayTime}*\n` +
      `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
      `ğŸ“¥ Thu: *${formatCurrency(totalInc)}*\n` +
      `ğŸ“¤ Chi: *${formatCurrency(totalExp)}*\n` +
      `ğŸ’° DÆ°: *${formatCurrency(balance)}* ${emoji}\n\n` +
      `ğŸ“‚ *CHI TIáº¾T CHI TIÃŠU:*\n${catText || "_Trá»‘ng_"}`;
  }

  sendMessage(chatId, resultText);
}

function undoLast(chatId) {
  const undoKey = `CAN_UNDO_${chatId}`;
  const allowedRow = PropertiesService.getScriptProperties().getProperty(undoKey);

  if (!allowedRow) {
    return sendMessage(chatId, "ğŸš« *KhÃ´ng thá»ƒ Undo!*\nBáº¡n chá»‰ Ä‘Æ°á»£c xÃ³a 1 láº§n cho giao dá»‹ch vá»«a má»›i nháº­p.");
  }

  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(getSheetNameByDate(new Date()));
  
  if (sheet) {
    const dataRange = sheet.getRange(`B${START_ROW}:B`);
    const lastRowIndex = dataRange.getValues().filter(String).length;
    const currentRow = START_ROW + lastRowIndex - 1;

    if (lastRowIndex > 0 && currentRow == parseInt(allowedRow)) {
      const targetRange = sheet.getRange(currentRow, START_COL, 1, 5);
      
      const rowData = targetRange.getValues()[0];
      const amount = rowData[3] || 0;
      const desc = rowData[4] || "KhÃ´ng mÃ´ táº£";
      
      targetRange.clearContent();
      targetRange.clearFormat();
      targetRange.clearDataValidations();
      
      PropertiesService.getScriptProperties().deleteProperty(undoKey);
      
      sendMessage(chatId, `âœ… ÄÃ£ xÃ³a giao dá»‹ch cuá»‘i:\n\nğŸ—‘ï¸ *${formatCurrency(amount)}* - ${desc}`);
      
    } else {
      PropertiesService.getScriptProperties().deleteProperty(undoKey);
      sendMessage(chatId, "âš ï¸ KhÃ´ng tÃ¬m tháº¥y giao dá»‹ch khá»›p lá»‡nh Ä‘á»ƒ xÃ³a.");
    }
  } else {
    sendMessage(chatId, "â„¹ï¸ ThÃ¡ng nÃ y chÆ°a cÃ³ dá»¯ liá»‡u.");
  }
}

// --- CÃC HÃ€M Xá»¬ LÃ Sá» TIá»€N Má»šI ---

function parseAmount(text) {
  if (!text) return 0;
  // XÃ³a dáº¥u pháº©y, dáº¥u cháº¥m náº¿u cÃ³, chuyá»ƒn vá» chá»¯ thÆ°á»ng
  let s = text.toString().toLowerCase().replace(/,/g, "").trim();

  // TRÆ¯á»œNG Há»¢P 1: Dáº¡ng káº¿t há»£p (VÃ­ dá»¥: 1tr600, 1tr600k, 1tr5)
  // Logic: TÃ¬m chá»¯ "tr" náº±m giá»¯a
  if (s.includes("tr") && s.indexOf("tr") < s.length - 2) { 
    // TÃ¡ch pháº§n trÆ°á»›c vÃ  sau chá»¯ "tr"
    let parts = s.split("tr");
    let phanTrieu = parseFloat(parts[0]) * 1000000;
    
    // Xá»­ lÃ½ pháº§n Ä‘uÃ´i (xÃ³a chá»¯ 'k' náº¿u cÃ³)
    let duoiStr = parts[1].replace("k", "").trim();
    let phanDuoi = parseFloat(duoiStr);
    
    if (isNaN(phanDuoi)) return phanTrieu;

    // Logic thÃ´ng minh cho pháº§n Ä‘uÃ´i:
    // Náº¿u nháº­p "1tr5" (Ä‘uÃ´i lÃ  5, Ä‘á»™ dÃ i 1 kÃ½ tá»±) => Hiá»ƒu lÃ  1.5 triá»‡u (cá»™ng thÃªm 500k)
    // Náº¿u nháº­p "1tr600" => Hiá»ƒu lÃ  1 triá»‡u + 600k
    if (phanDuoi < 10 && duoiStr.length === 1) {
       return phanTrieu + (phanDuoi * 100000);
    } else {
       return phanTrieu + (phanDuoi * 1000);
    }
  }

  // TRÆ¯á»œNG Há»¢P 2: Dáº¡ng Ä‘Æ¡n giáº£n (10tr, 500k, 500000)
  let multiplier = 1;
  if (s.includes("tr")) multiplier = 1000000;
  else if (s.includes("k")) multiplier = 1000;

  return parseFloat(s.replace(/tr|k/gi, "")) * multiplier;
}

function isValidAmount(a) {
  const val = parseAmount(a);
  return !isNaN(val) && val > 0;
}

function sendCategoryKeyboard(chatId, text) {
  const keyboard = []; let row = [];
  CATEGORIES.forEach((cat, i) => {
    row.push({ text: cat, callback_data: cat });
    if (row.length === 2 || i === CATEGORIES.length - 1) { keyboard.push(row); row = []; }
  });
  UrlFetchApp.fetch(`${API_URL}/sendMessage`, { method: "post", payload: JSON.stringify({ chat_id: chatId, text: text, reply_markup: { inline_keyboard: keyboard } }), contentType: 'application/json' });
}

function editMessage(chatId, messageId, text) { UrlFetchApp.fetch(`${API_URL}/editMessageText`, { method: "post", payload: JSON.stringify({ chat_id: chatId, message_id: messageId, text: text }), contentType: 'application/json' }); }
function setUserState(id, s, d) { CacheService.getScriptCache().put(id, JSON.stringify({state:s, data:d}), 600); }
function getUserState(id) { const c = CacheService.getScriptCache().get(id); return c ? JSON.parse(c).state : null; }
function getUserData(id) { const c = CacheService.getScriptCache().get(id); return c ? JSON.parse(c).data : {}; }
function clearUserState(id, cid) { CacheService.getScriptCache().remove(id); if(cid) sendMessage(cid, "âŒ Há»§y."); }
function getSheetNameByDate(d) { return `T${d.getMonth() + 1}-${d.getFullYear()}`; }
function isAuthorizedUser(id) { return ADMIN_IDS.includes(String(id)); }
function formatCurrency(n) { return new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(n); }
function sendMessage(chatId, text) { UrlFetchApp.fetch(`${API_URL}/sendMessage`, { method: "post", payload: JSON.stringify({ chat_id: chatId, text: text, parse_mode: "Markdown" }), contentType: 'application/json' }); }
function getGoldPrices() { try { const ts = new Date().getTime(); const url = `https://data.giavangvietnam.com/api/data/sjc?cache=${ts}`; const ss = SpreadsheetApp.openById(SHEET_ID); let s = ss.getSheetByName("goldprices") || ss.insertSheet("goldprices"); s.getRange("A1").setFormula(`=IMPORTHTML("${url}"; "table"; 1)`); const d = s.getRange("A3:D3").getValues()[0]; return `ğŸ”” *GiÃ¡ VÃ ng SJC*\nMua: ${d[2]}\nBÃ¡n: ${d[3]}`; } catch (e) { return "âŒ Lá»—i."; } }